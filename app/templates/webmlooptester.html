<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Loop Test</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1b26;
        color: #f8f8f2;
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: #bd93f9;
      }

      .test-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .test-box {
        background: #282a36;
        border: 2px solid #44475a;
        border-radius: 8px;
        padding: 20px;
      }

      .test-box h2 {
        color: #ff79c6;
        margin-top: 0;
      }

      video {
        width: 100%;
        max-width: 100%;
        border: 2px solid #6272a4;
        border-radius: 4px;
        background: #000;
      }

      .info {
        margin: 10px 0;
        padding: 10px;
        background: #1a1b26;
        border-left: 3px solid #50fa7b;
        font-size: 12px;
      }

      .warning {
        border-left-color: #ffb86c;
      }

      .error {
        border-left-color: #ff5555;
      }

      input {
        width: 100%;
        padding: 8px;
        background: #44475a;
        border: 1px solid #6272a4;
        color: #f8f8f2;
        border-radius: 4px;
        margin: 10px 0;
      }

      button {
        padding: 8px 16px;
        background: #bd93f9;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        margin: 5px 5px 5px 0;
      }

      button:hover {
        background: #ff79c6;
      }

      .log-box {
        background: #1a1b26;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #44475a;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 11px;
      }

      .log-entry {
        margin: 2px 0;
        padding: 2px 5px;
      }

      .log-ended {
        color: #ff5555;
        font-weight: bold;
      }

      .log-playing {
        color: #50fa7b;
      }

      .log-paused {
        color: #ffb86c;
      }
    </style>
  </head>
  <body>
    <h1>ðŸŽ¬ Video Loop Test Tool</h1>
    <p>Test your WebM/MP4 files to see if they loop correctly.</p>

    <div
      style="
        margin: 20px 0;
        padding: 15px;
        background: #282a36;
        border-radius: 8px;
      "
    >
      <strong>Enter video filename:</strong>
      <input type="text" id="videoFilename" placeholder="video.webm" value="" />
      <button onclick="loadVideo()">Load Video</button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="test-container">
      <!-- Test 1: Native Loop -->
      <div class="test-box">
        <h2>Test 1: Native Loop Attribute</h2>
        <div class="info">Uses HTML5 <code>loop</code> attribute only</div>
        <video id="video1" muted autoplay loop>
          <source src="" type="video/webm" />
        </video>
        <div class="log-box" id="log1"></div>
      </div>

      <!-- Test 2: JavaScript Fallback -->
      <div class="test-box">
        <h2>Test 2: Loop + JS Fallback</h2>
        <div class="info">
          Uses <code>loop</code> + <code>onended</code> handler
        </div>
        <video id="video2" muted autoplay loop>
          <source src="" type="video/webm" />
        </video>
        <div class="log-box" id="log2"></div>
      </div>

      <!-- Test 3: Pure JavaScript Loop -->
      <div class="test-box">
        <h2>Test 3: Pure JavaScript Loop</h2>
        <div class="info warning">
          Uses only JavaScript, no <code>loop</code> attribute
        </div>
        <video id="video3" muted autoplay>
          <source src="" type="video/webm" />
        </video>
        <div class="log-box" id="log3"></div>
      </div>

      <!-- Test 4: With Controls -->
      <div class="test-box">
        <h2>Test 4: With Controls</h2>
        <div class="info">Loop with user controls visible</div>
        <video id="video4" muted autoplay loop controls>
          <source src="" type="video/webm" />
        </video>
        <div class="log-box" id="log4"></div>
      </div>
    </div>

    <div class="test-box" style="margin-top: 20px">
      <h2>ðŸ“Š Statistics</h2>
      <div id="stats"></div>
    </div>

    <script>
      let loopCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };
      let startTime = Date.now();

      function log(videoNum, message, className = "") {
        const logBox = document.getElementById(`log${videoNum}`);
        const entry = document.createElement("div");
        entry.className = "log-entry " + className;
        const time = new Date().toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
        updateStats();
      }

      function updateStats() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const stats = document.getElementById("stats");
        stats.innerHTML = `
                <div class="info">
                    <strong>Time elapsed:</strong> ${elapsed} seconds<br>
                    <strong>Loop counts:</strong><br>
                    - Test 1 (Native): ${loopCounts[1]} loops<br>
                    - Test 2 (Fallback): ${loopCounts[2]} loops<br>
                    - Test 3 (JS Only): ${loopCounts[3]} loops<br>
                    - Test 4 (Controls): ${loopCounts[4]} loops
                </div>
            `;
      }

      function clearLogs() {
        for (let i = 1; i <= 4; i++) {
          document.getElementById(`log${i}`).innerHTML = "";
          loopCounts[i] = 0;
        }
        startTime = Date.now();
        updateStats();
      }

      function setupVideo(videoId, num) {
        const video = document.getElementById(videoId);

        video.addEventListener("loadeddata", () => {
          log(
            num,
            `âœ… Video loaded (duration: ${video.duration.toFixed(2)}s)`,
            "log-playing"
          );
        });

        video.addEventListener("play", () => {
          log(num, "â–¶ï¸ Playing", "log-playing");
        });

        video.addEventListener("pause", () => {
          log(num, "â¸ï¸ Paused", "log-paused");
        });

        video.addEventListener("ended", () => {
          loopCounts[num]++;
          log(num, `ðŸ” Video ended! (Loop #${loopCounts[num]})`, "log-ended");
        });

        video.addEventListener("error", (e) => {
          log(
            num,
            `âŒ Error: ${video.error ? video.error.message : "Unknown"}`,
            "error"
          );
        });

        // Test 2: Add JavaScript fallback
        if (num === 2) {
          video.addEventListener("ended", () => {
            log(num, "   â†³ JS Fallback: Restarting video...", "log-playing");
            video.currentTime = 0;
            video.play();
          });
        }

        // Test 3: Pure JavaScript looping
        if (num === 3) {
          video.addEventListener("ended", () => {
            log(num, "   â†³ Pure JS: Restarting video...", "log-playing");
            video.currentTime = 0;
            video.play().catch((err) => {
              log(num, `   â†³ Failed to restart: ${err}`, "error");
            });
          });
        }
      }

      function loadVideo() {
        const filename = document.getElementById("videoFilename").value.trim();

        if (!filename) {
          alert("Please enter a video filename");
          return;
        }

        const url = `/images/${filename}`;
        const ext = filename.toLowerCase().split(".").pop();
        const mimeType = ext === "mp4" ? "video/mp4" : "video/webm";

        clearLogs();

        // Update all videos
        for (let i = 1; i <= 4; i++) {
          const video = document.getElementById(`video${i}`);
          const source = video.querySelector("source");
          source.src = url;
          source.type = mimeType;
          video.load();
          log(i, `Loading: ${filename} (${mimeType})`);
        }
      }

      // Setup all videos
      for (let i = 1; i <= 4; i++) {
        setupVideo(`video${i}`, i);
      }

      updateStats();

      // Instructions
      console.log("ðŸŽ¬ Video Loop Test Tool");
      console.log('Enter a video filename and click "Load Video"');
      console.log("Watch the loop counts to see which method works best");
      console.log("");
      console.log("Expected behavior:");
      console.log("âœ… All 4 tests should loop indefinitely");
      console.log(
        "âš ï¸  If Test 1 fails but Test 2 works = Native loop broken, JS fallback needed"
      );
      console.log("âŒ If all fail = Video file has issues");
    </script>
  </body>
</html>
