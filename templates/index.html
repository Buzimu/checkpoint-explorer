<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ComfyUI Model Explorer</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    />
  </head>
  <body>
    <div class="app-container" x-data="modelExplorer()" x-init="init()" x-cloak>
      <div class="sidebar">
        <div class="header">
          <h1>üé® ComfyUI Model Explorer</h1>
          <div class="models-path">/models/checkpoints/</div>
        </div>

        <div class="filter-section">
          <input
            type="text"
            class="search-box"
            placeholder="Search models..."
            x-model="searchQuery"
            @input="filterModels()"
          />
          <div class="model-types">
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'all' }"
              @click="setFilter('all')"
            >
              All
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'checkpoint' }"
              @click="setFilter('checkpoint')"
            >
              Checkpoints
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'lora' }"
              @click="setFilter('lora')"
            >
              LoRAs
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'vae' }"
              @click="setFilter('vae')"
            >
              VAE
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'controlnet' }"
              @click="setFilter('controlnet')"
            >
              ControlNet
            </div>
          </div>
        </div>

        <div class="models-list">
          <template x-for="model in filteredModels" :key="model.id">
            <div
              class="model-item"
              :class="{ 'active': selectedModel && selectedModel.id === model.id }"
              @click="selectModel(model)"
            >
              <div class="model-name" x-text="model.name"></div>
              <div class="model-type" x-text="model.type"></div>
              <div class="model-size" x-text="model.size"></div>
            </div>
          </template>

          <div x-show="filteredModels.length === 0" class="no-models">
            <p>No models found matching your criteria.</p>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="top-bar">
          <div
            class="model-title"
            x-text="selectedModel ? selectedModel.name : 'Select a Model'"
          ></div>
          <div class="action-buttons">
            <template x-if="!selectedModel || models.length === 0">
              <button class="btn btn-primary" @click="openSettings()">
                ‚öôÔ∏è Configure Models Directory
              </button>
            </template>
            <template x-if="selectedModel">
              <div style="display: flex; gap: 12px">
                <a
                  href="#"
                  class="btn btn-secondary"
                  @click.prevent="openFolder()"
                  >üìÅ Open Folder</a
                >
                <a
                  href="#"
                  class="btn btn-secondary"
                  @click.prevent="editNotes()"
                  >üìù Edit Notes</a
                >
                <a
                  href="#"
                  class="btn btn-primary"
                  @click.prevent="openCivitAI()"
                  >üåê View on CivitAI</a
                >
              </div>
            </template>
          </div>
        </div>

        <div class="content-area" x-show="selectedModel">
          <div class="info-grid">
            <div class="info-card">
              <h3>üìä Model Information</h3>
              <div class="info-item">
                <span class="info-label">File Size</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.size || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Format</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.format || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Base Model</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.base_model || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Created</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.created || 'Unknown'"
                ></span>
              </div>
            </div>

            <div class="info-card">
              <h3>‚öôÔ∏è Quick Info</h3>
              <div class="info-item">
                <span class="info-label">Type</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.type || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Has Notes</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.has_notes ? 'Yes' : 'No'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Examples</span>
                <span
                  class="info-value"
                  x-text="(selectedModel?.examples?.length || 0)"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Path</span>
                <span
                  class="info-value model-path"
                  x-text="selectedModel?.path || 'Unknown'"
                  title="Click to copy"
                  @click="copyPath()"
                ></span>
              </div>
            </div>
          </div>

          <div
            class="gallery-section"
            x-show="selectedModel && selectedModel.examples && selectedModel.examples.length > 0"
          >
            <h3>üñºÔ∏è Example Images</h3>
            <div class="gallery-grid">
              <template
                x-for="example in (selectedModel?.examples || [])"
                :key="example.type"
              >
                <div class="gallery-item" @click="viewExample(example)">
                  <img
                    :src="getExampleImage(example.type)"
                    :alt="example.type + ' example'"
                  />
                  <div class="gallery-overlay">
                    <span class="gallery-prompt" x-text="example.prompt"></span>
                  </div>
                </div>
              </template>
              <div class="gallery-item add-image" @click="addExample()">
                <div class="add-image-content">
                  <span class="add-icon">+</span>
                  <span class="add-text">Add Example</span>
                </div>
              </div>
            </div>
          </div>

          <div class="notes-section">
            <h3>üìù Author Notes & Tips</h3>
            <div class="notes-content" x-show="selectedModel?.notes">
              <pre
                x-text="selectedModel?.notes || 'No notes available for this model.'"
              ></pre>
            </div>
            <div class="notes-empty" x-show="!selectedModel?.notes">
              <p>No notes available for this model.</p>
              <button class="btn btn-secondary" @click="editNotes()">
                Add Notes
              </button>
            </div>
          </div>
        </div>

        <div class="welcome-screen" x-show="!selectedModel">
          <template x-if="models.length === 0">
            <div style="text-align: center">
              <h2>Welcome to ComfyUI Model Explorer</h2>
              <p>
                Get started by configuring your ComfyUI models directory to scan
                and organize your collection.
              </p>
              <button
                class="btn btn-primary"
                @click="openSettings()"
                style="margin: 20px 0"
              >
                üìÇ Configure Models Directory
              </button>
              <div class="stats">
                <div class="stat-item">
                  <span class="stat-number" x-text="models?.length || 0"></span>
                  <span class="stat-label">Models Found</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="(models || []).filter(m => m?.has_notes).length"
                  ></span>
                  <span class="stat-label">With Notes</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="new Set((models || []).map(m => m?.type).filter(Boolean)).size"
                  ></span>
                  <span class="stat-label">Types</span>
                </div>
              </div>
            </div>
          </template>
          <template x-if="models.length > 0">
            <div style="text-align: center">
              <h2>Welcome to ComfyUI Model Explorer</h2>
              <p>
                Select a model from the sidebar to view its details, examples,
                and notes.
              </p>
              <div class="stats">
                <div class="stat-item">
                  <span class="stat-number" x-text="models?.length || 0"></span>
                  <span class="stat-label">Models Found</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="(models || []).filter(m => m?.has_notes).length"
                  ></span>
                  <span class="stat-label">With Notes</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="new Set((models || []).map(m => m?.type).filter(Boolean)).size"
                  ></span>
                  <span class="stat-label">Types</span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      class="modal-overlay"
      x-show="showSettings"
      x-transition:enter="fade-enter-active"
      x-transition:enter-start="fade-enter-from"
      x-transition:leave="fade-leave-active"
      x-transition:leave-to="fade-leave-to"
      @click.self="closeSettings()"
    >
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>‚öôÔ∏è Settings</h3>
          <button type="button" class="modal-close" @click="closeSettings()">
            √ó
          </button>
        </div>

        <div class="modal-body">
          <div class="setting-group">
            <label class="setting-label">Models Directory</label>
            <div class="directory-input-group">
              <input
                type="text"
                class="setting-input"
                x-model="settingsForm.models_directory"
                placeholder="e.g., C:\ComfyUI\models or /path/to/comfyui/models"
                @keydown.enter="saveSettings()"
              />
              <button
                type="button"
                class="btn btn-secondary"
                @click="browseDirectory()"
              >
                üìÇ Browse
              </button>
            </div>
            <small class="setting-help">
              Point to your ComfyUI models directory (should contain subfolders
              like 'checkpoints', 'loras', 'vae', etc.)
            </small>
          </div>

          <div class="setting-group">
            <label class="setting-checkbox">
              <input type="checkbox" x-model="settingsForm.auto_scan" />
              <span class="checkmark"></span>
              Auto-scan on startup
            </label>
            <small class="setting-help">
              Automatically scan for new models when the app starts
            </small>
          </div>

          <div class="setting-group">
            <label class="setting-checkbox">
              <input type="checkbox" x-model="settingsForm.show_examples" />
              <span class="checkmark"></span>
              Show example images
            </label>
            <small class="setting-help">
              Display example images in model details (when available)
            </small>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" @click="closeSettings()">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            @click="saveSettings()"
            :disabled="!settingsForm.models_directory"
          >
            Save & Scan Models
          </button>
        </div>

        <div class="scan-progress" x-show="scanProgress.active">
          <div class="progress-bar">
            <div
              class="progress-fill"
              :style="`width: ${scanProgress.percent}%`"
            ></div>
          </div>
          <div class="progress-text">
            <span x-text="scanProgress.message"></span>
            <span
              x-text="`${scanProgress.current}/${scanProgress.total}`"
            ></span>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" :class="{ 'connected': isConnected }"></div>
        <span
          x-text="isConnected ? 'Connected to ComfyUI (localhost:8188)' : 'ComfyUI not detected'"
        ></span>
      </div>
      <div
        x-text="(models?.length || 0) + ' models loaded ‚Ä¢ ' + (models || []).filter(m => m?.has_notes).length + ' with custom notes'"
      ></div>
    </div>

    <!-- Alpine.js for interactivity -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
