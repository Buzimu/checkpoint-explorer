<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ComfyUI Model Explorer</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    />
  </head>
  <body>
    <div class="app-container" x-data="modelExplorer()" x-init="init()" x-cloak>
      <div class="sidebar">
        <div class="header">
          <h1>üé® ComfyUI Model Explorer</h1>
          <div class="models-path">/models/checkpoints/</div>
        </div>

        <div class="filter-section">
          <input
            type="text"
            class="search-box"
            placeholder="Search models..."
            x-model="searchQuery"
            @input="filterModels()"
          />
          <div class="model-types">
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'all' }"
              @click="setFilter('all')"
            >
              All
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'checkpoint' }"
              @click="setFilter('checkpoint')"
            >
              Checkpoints
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'lora' }"
              @click="setFilter('lora')"
            >
              LoRAs
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'vae' }"
              @click="setFilter('vae')"
            >
              VAE
            </div>
            <div
              class="type-filter"
              :class="{ 'active': selectedType === 'controlnet' }"
              @click="setFilter('controlnet')"
            >
              ControlNet
            </div>
          </div>
        </div>

        <div class="models-list">
          <template x-for="model in filteredModels" :key="model.id">
            <div
              class="model-item"
              :class="{ 'active': selectedModel && selectedModel.id === model.id }"
              @click="selectModel(model)"
            >
              <div class="model-name" x-text="model.name"></div>
              <div class="model-type" x-text="model.type"></div>
              <div class="model-size" x-text="model.size"></div>
            </div>
          </template>

          <div x-show="filteredModels.length === 0" class="no-models">
            <p>No models found matching your criteria.</p>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="top-bar">
          <div
            class="model-title"
            x-text="selectedModel ? selectedModel.name : 'Select a Model'"
          ></div>
          <div class="action-buttons">
            <template x-if="!selectedModel || models.length === 0">
              <button class="btn btn-primary" @click="openSettings()">
                ‚öôÔ∏è Configure Models Directory
              </button>
            </template>
            <template x-if="selectedModel">
              <div style="display: flex; gap: 12px">
                <a
                  href="#"
                  class="btn btn-secondary"
                  @click.prevent="openFolder()"
                  >üìÅ Open Folder</a
                >
                <a
                  href="#"
                  class="btn btn-secondary"
                  @click.prevent="editNotes()"
                  >üìù Edit Notes</a
                >
                <a
                  href="#"
                  class="btn btn-primary"
                  @click.prevent="openCivitAI()"
                  >üåê View on CivitAI</a
                >
              </div>
            </template>
          </div>
        </div>

        <div class="content-area" x-show="selectedModel">
          <div class="info-grid">
            <div class="info-card">
              <h3>üìä Model Information</h3>
              <div class="info-item">
                <span class="info-label">File Size</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.size || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Format</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.format || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Base Model</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.base_model || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Created</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.created || 'Unknown'"
                ></span>
              </div>
            </div>

            <div class="info-card">
              <h3>‚öôÔ∏è Quick Info</h3>
              <div class="info-item">
                <span class="info-label">Type</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.type || 'Unknown'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Has Notes</span>
                <span
                  class="info-value"
                  x-text="selectedModel?.has_notes ? 'Yes' : 'No'"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Examples</span>
                <span
                  class="info-value"
                  x-text="(selectedModel?.examples?.length || 0)"
                ></span>
              </div>
              <div class="info-item">
                <span class="info-label">Path</span>
                <span
                  class="info-value model-path"
                  x-text="selectedModel?.path || 'Unknown'"
                  title="Click to copy"
                  @click="copyPath()"
                ></span>
              </div>
            </div>
          </div>

          <div
            class="gallery-section"
            x-show="selectedModel && selectedModel.examples && selectedModel.examples.length > 0"
          >
            <h3>üñºÔ∏è Example Images</h3>
            <div class="gallery-grid">
              <template
                x-for="example in (selectedModel?.examples || [])"
                :key="example.type"
              >
                <div class="gallery-item" @click="viewExample(example)">
                  <img
                    :src="getExampleImage(example.type)"
                    :alt="example.type + ' example'"
                  />
                  <div class="gallery-overlay">
                    <span class="gallery-prompt" x-text="example.prompt"></span>
                  </div>
                </div>
              </template>
              <div class="gallery-item add-image" @click="addExample()">
                <div class="add-image-content">
                  <span class="add-icon">+</span>
                  <span class="add-text">Add Example</span>
                </div>
              </div>
            </div>
          </div>

          <div class="notes-section">
            <h3>üìù Author Notes & Tips</h3>
            <div class="notes-content" x-show="selectedModel?.notes">
              <pre
                x-text="selectedModel?.notes || 'No notes available for this model.'"
              ></pre>
            </div>
            <div class="notes-empty" x-show="!selectedModel?.notes">
              <p>No notes available for this model.</p>
              <button class="btn btn-secondary" @click="editNotes()">
                Add Notes
              </button>
            </div>
          </div>
        </div>

        <div class="welcome-screen" x-show="!selectedModel">
          <template x-if="models.length === 0">
            <div style="text-align: center">
              <h2>Welcome to ComfyUI Model Explorer</h2>
              <p>
                Get started by configuring your ComfyUI models directory to scan
                and organize your collection.
              </p>
              <button
                class="btn btn-primary"
                @click="openSettings()"
                style="margin: 20px 0"
              >
                üìÇ Configure Models Directory
              </button>
              <div class="stats">
                <div class="stat-item">
                  <span class="stat-number" x-text="models?.length || 0"></span>
                  <span class="stat-label">Models Found</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="(models || []).filter(m => m?.has_notes).length"
                  ></span>
                  <span class="stat-label">With Notes</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="new Set((models || []).map(m => m?.type).filter(Boolean)).size"
                  ></span>
                  <span class="stat-label">Types</span>
                </div>
              </div>
            </div>
          </template>
          <template x-if="models.length > 0">
            <div style="text-align: center">
              <h2>Welcome to ComfyUI Model Explorer</h2>
              <p>
                Select a model from the sidebar to view its details, examples,
                and notes.
              </p>
              <div class="stats">
                <div class="stat-item">
                  <span class="stat-number" x-text="models?.length || 0"></span>
                  <span class="stat-label">Models Found</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="(models || []).filter(m => m?.has_notes).length"
                  ></span>
                  <span class="stat-label">With Notes</span>
                </div>
                <div class="stat-item">
                  <span
                    class="stat-number"
                    x-text="new Set((models || []).map(m => m?.type).filter(Boolean)).size"
                  ></span>
                  <span class="stat-label">Types</span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      class="modal-overlay"
      x-show="showSettings"
      x-transition:enter="fade-enter-active"
      x-transition:enter-start="fade-enter-from"
      x-transition:leave="fade-leave-active"
      x-transition:leave-to="fade-leave-to"
      @click.self="closeSettings()"
    >
      <div class="modal-content" @click.stop="">
        <div class="modal-header">
          <h3>‚öôÔ∏è Settings</h3>
          <button
            type="button"
            class="modal-close"
            @click.prevent="closeSettings()"
          >
            √ó
          </button>
        </div>

        <div class="modal-body">
          <div class="setting-group">
            <label class="setting-label">Models Directory</label>
            <div class="directory-input-group">
              <input
                type="text"
                class="setting-input"
                x-model="settingsForm.models_directory"
                placeholder="e.g., S:\AI\Image Models\models"
                @keydown.enter.prevent="saveSettings()"
              />
              <button
                type="button"
                class="btn btn-secondary"
                @click.prevent="browseDirectory()"
              >
                üìÇ Browse
              </button>
            </div>
            <small class="setting-help">
              Enter the full path to your ComfyUI models directory (should
              contain subfolders like 'checkpoints', 'loras', 'vae', etc.)
            </small>
          </div>

          <div class="setting-group">
            <label class="setting-checkbox">
              <input type="checkbox" x-model="settingsForm.auto_scan" />
              <span>Auto-scan on startup</span>
            </label>
            <small class="setting-help">
              Automatically scan for new models when the app starts
            </small>
          </div>

          <div class="setting-group">
            <label class="setting-checkbox">
              <input type="checkbox" x-model="settingsForm.show_examples" />
              <span>Show example images</span>
            </label>
            <small class="setting-help">
              Display example images in model details (when available)
            </small>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            @click.prevent="closeSettings()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            @click.prevent="saveSettings()"
            :disabled="!settingsForm.models_directory || !settingsForm.models_directory.trim()"
          >
            <span x-show="!scanProgress.active">Save & Scan Models</span>
            <span x-show="scanProgress.active">Scanning...</span>
          </button>
        </div>

        <div class="scan-progress" x-show="scanProgress.active">
          <div class="progress-bar">
            <div
              class="progress-fill"
              :style="`width: ${scanProgress.percent}%`"
            ></div>
          </div>
          <div class="progress-text">
            <span x-text="scanProgress.message"></span>
            <span x-text="`${scanProgress.percent}%`"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Notes Editor Modal -->
    <!-- Add this to your existing templates/index.html, after the Settings Modal -->

    <div
      class="notes-editor-modal"
      x-show="notesEditor.isOpen"
      x-transition:enter="fade-enter-active"
      x-transition:enter-start="fade-enter-from"
      x-transition:leave="fade-leave-active"
      x-transition:leave-to="fade-leave-to"
      @click.self="closeNotesEditor()"
      style="display: none"
    >
      <div class="notes-editor-content" @click.stop="">
        <!-- Header -->
        <div class="notes-editor-header">
          <h3 class="notes-editor-title">
            üìù Edit Notes:
            <span x-text="selectedModel?.name || 'Unknown Model'"></span>
          </h3>
          <button
            type="button"
            class="modal-close"
            @click="closeNotesEditor()"
            title="Close (Esc)"
          >
            √ó
          </button>
        </div>

        <!-- Toolbar -->
        <div class="notes-editor-toolbar">
          <!-- Formatting buttons -->
          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              title="Bold (Ctrl+B)"
              @click="insertFormatting('**', '**')"
            >
              <strong>B</strong>
            </button>
            <button
              class="toolbar-btn"
              title="Italic (Ctrl+I)"
              @click="insertFormatting('*', '*')"
            >
              <em>I</em>
            </button>
            <button
              class="toolbar-btn"
              title="Code (Ctrl+`)"
              @click="insertFormatting('`', '`')"
            >
              &lt;/&gt;
            </button>
          </div>

          <div class="toolbar-separator"></div>

          <!-- Structure buttons -->
          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              title="Add Heading"
              @click="insertFormatting('## ', '')"
            >
              H
            </button>
            <button
              class="toolbar-btn"
              title="Add List Item"
              @click="insertFormatting('- ', '')"
            >
              ‚â°
            </button>
            <button
              class="toolbar-btn"
              title="Add Separator"
              @click="insertText('\n---\n')"
            >
              ‚îÄ
            </button>
          </div>

          <div class="toolbar-separator"></div>

          <!-- Templates dropdown -->
          <div class="toolbar-group">
            <div
              class="template-dropdown"
              :class="{ 'open': notesEditor.showTemplateDropdown }"
            >
              <button
                class="template-btn toolbar-btn"
                @click="toggleTemplateDropdown()"
                title="Apply template"
              >
                üìã Templates ‚ñº
              </button>
              <div class="template-dropdown-content">
                <template
                  x-for="template in notesEditor.templates"
                  :key="template.id"
                >
                  <div
                    class="template-item"
                    @click="applyTemplate(template.id)"
                  >
                    <div class="template-name" x-text="template.name"></div>
                    <div
                      class="template-description"
                      x-text="template.description"
                    ></div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Backup restore (if backups exist) -->
          <template x-if="notesEditor.backups.length > 0">
            <div class="toolbar-group">
              <div class="toolbar-separator"></div>
              <select
                class="toolbar-btn"
                style="
                  padding: 4px 8px;
                  background: rgba(68, 71, 90, 0.5);
                  border: 1px solid #6272a4;
                  border-radius: 4px;
                  color: #f8f8f2;
                  font-size: 12px;
                "
                @change="$event.target.value && restoreBackup($event.target.value); $event.target.value = ''"
                title="Restore from backup"
              >
                <option value="">üìö Restore Backup</option>
                <template
                  x-for="backup in notesEditor.backups"
                  :key="backup.filename"
                >
                  <option
                    :value="backup.filename"
                    x-text="`${backup.filename} (${new Date(backup.created).toLocaleDateString()})`"
                  ></option>
                </template>
              </select>
            </div>
          </template>
        </div>

        <!-- Editor Body -->
        <div class="notes-editor-body">
          <textarea
            id="notesTextarea"
            class="notes-textarea"
            x-model="notesEditor.content"
            @input="onNotesInput()"
            @keydown="handleNotesKeydown($event)"
            placeholder="Enter your notes here...

Use the toolbar above for formatting, or type manually:
‚Ä¢ **bold text** for emphasis
‚Ä¢ *italic text* for subtle emphasis  
‚Ä¢ `code` for settings or technical terms
‚Ä¢ ## Headings for organization
‚Ä¢ - List items for organization

Tips:
‚Ä¢ Save automatically happens every 5 seconds
‚Ä¢ Use Ctrl+S to save manually
‚Ä¢ Use Ctrl+Z to undo changes
‚Ä¢ Use templates for quick formatting"
            spellcheck="true"
          ></textarea>
        </div>

        <!-- Footer -->
        <div class="notes-editor-footer">
          <div class="editor-status">
            <!-- Auto-save status -->
            <div
              class="auto-save-indicator"
              :style="{ color: getAutoSaveStatusColor() }"
            >
              <span>‚óè</span>
              <span x-text="getAutoSaveStatusText()"></span>
            </div>

            <!-- Word count -->
            <div class="word-count">
              <span x-text="notesEditor.charCount"></span> characters,
              <span x-text="notesEditor.wordCount"></span> words
            </div>

            <!-- Last saved indicator -->
            <template x-if="notesEditor.lastSaved">
              <div style="color: #6272a4; font-size: 11px">
                Last saved:
                <span
                  x-text="notesEditor.lastSaved.toLocaleTimeString()"
                ></span>
              </div>
            </template>
          </div>

          <div class="editor-actions">
            <button
              class="btn btn-secondary"
              @click="closeNotesEditor()"
              title="Cancel changes (Esc)"
            >
              Cancel
            </button>

            <button
              class="btn btn-primary"
              @click="saveAndCloseNotes()"
              :disabled="!notesEditor.isDirty"
              title="Save and close (Ctrl+S)"
            >
              <template x-if="notesEditor.autoSaveStatus === 'saving'">
                <span>üíæ Saving...</span>
              </template>
              <template x-if="notesEditor.autoSaveStatus !== 'saving'">
                <span>üíæ Save & Close</span>
              </template>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add these styles to your main.css -->
    <style>
      .notes-editor-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(4px);
      }

      .notes-editor-content {
        background: rgba(40, 42, 54, 0.98);
        border: 1px solid #44475a;
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
      }

      .notes-editor-header {
        padding: 20px;
        border-bottom: 1px solid #44475a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(68, 71, 90, 0.3);
      }

      .notes-editor-title {
        color: #bd93f9;
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .notes-editor-toolbar {
        padding: 15px 20px;
        border-bottom: 1px solid #44475a;
        background: rgba(68, 71, 90, 0.2);
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .toolbar-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .toolbar-btn {
        padding: 6px 10px;
        background: rgba(68, 71, 90, 0.5);
        border: 1px solid #6272a4;
        border-radius: 4px;
        color: #f8f8f2;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        min-width: 32px;
        justify-content: center;
      }

      .toolbar-btn:hover {
        background: rgba(189, 147, 249, 0.2);
        border-color: #bd93f9;
      }

      .toolbar-btn.active {
        background: #bd93f9;
        color: #282a36;
        border-color: #bd93f9;
      }

      .toolbar-separator {
        width: 1px;
        height: 20px;
        background: #44475a;
        margin: 0 4px;
      }

      .notes-editor-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .notes-textarea {
        flex: 1;
        padding: 20px;
        background: rgba(40, 42, 54, 0.5);
        border: none;
        color: #f8f8f2;
        font-family: "Courier New", "Consolas", monospace;
        font-size: 14px;
        line-height: 1.6;
        resize: none;
        outline: none;
        min-height: 300px;
      }

      .notes-textarea::placeholder {
        color: #6272a4;
        font-style: italic;
      }

      .notes-editor-footer {
        padding: 15px 20px;
        border-top: 1px solid #44475a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(68, 71, 90, 0.2);
      }

      .editor-status {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #6272a4;
        font-size: 12px;
      }

      .auto-save-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 500;
      }

      .word-count {
        font-family: monospace;
      }

      .editor-actions {
        display: flex;
        gap: 12px;
      }

      .template-dropdown {
        position: relative;
        display: inline-block;
      }

      .template-btn {
        padding: 6px 12px;
        background: rgba(68, 71, 90, 0.5);
        border: 1px solid #6272a4;
        border-radius: 4px;
        color: #f8f8f2;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .template-dropdown-content {
        position: absolute;
        bottom: 100%;
        left: 0;
        background: rgba(40, 42, 54, 0.98);
        border: 1px solid #44475a;
        border-radius: 6px;
        min-width: 220px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        max-height: 300px;
        overflow-y: auto;
      }

      .template-dropdown.open .template-dropdown-content {
        display: block;
      }

      .template-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid rgba(68, 71, 90, 0.5);
        transition: background 0.2s ease;
      }

      .template-item:last-child {
        border-bottom: none;
      }

      .template-item:hover {
        background: rgba(189, 147, 249, 0.1);
      }

      .template-name {
        font-weight: 500;
        color: #f8f8f2;
        margin-bottom: 2px;
        font-size: 13px;
      }

      .template-description {
        font-size: 11px;
        color: #6272a4;
        line-height: 1.3;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .notes-editor-content {
          width: 95%;
          max-height: 90vh;
        }

        .toolbar-group {
          flex-wrap: wrap;
        }

        .editor-actions {
          flex-direction: column;
          gap: 8px;
        }

        .editor-status {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
      }

      /* Enhanced scrollbar for notes editor */
      .notes-textarea::-webkit-scrollbar {
        width: 8px;
      }

      .notes-textarea::-webkit-scrollbar-track {
        background: rgba(40, 42, 54, 0.5);
      }

      .notes-textarea::-webkit-scrollbar-thumb {
        background: #6272a4;
        border-radius: 4px;
      }

      .notes-textarea::-webkit-scrollbar-thumb:hover {
        background: #bd93f9;
      }
    </style>

    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" :class="{ 'connected': isConnected }"></div>
        <span
          x-text="isConnected ? 'Connected to ComfyUI (localhost:8188)' : 'ComfyUI not detected'"
        ></span>
      </div>
      <div
        x-text="(models?.length || 0) + ' models loaded ‚Ä¢ ' + (models || []).filter(m => m?.has_notes).length + ' with custom notes'"
      ></div>
    </div>

    <!-- Alpine.js for interactivity -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
